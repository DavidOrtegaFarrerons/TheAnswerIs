{% extends 'base.html.twig' %}

{% block title %}Contestant - Play{% endblock %}

{% block body %}
    <div class="min-h-screen bg-gradient-to-br from-purple-700 via-indigo-700 to-blue-700 flex items-center justify-center p-4">
        <div class="w-full max-w-3xl rounded-3xl bg-neutral-900/80 backdrop-blur-md shadow-2xl shadow-black/60 p-8 space-y-8">

            <div class="flex justify-center gap-2" id="stepper">
                {% for i in 1..15 %}
                    <div id="step-{{ i }}"
                         class="w-7 h-7 rounded-full border-2 border-blue-600 text-white text-xs font-bold flex items-center justify-center bg-neutral-800/80 transition-all duration-150">
                        {{ i }}
                    </div>
                {% endfor %}
            </div>

            <div id="question-text" class="rounded-2xl border-4 border-blue-600 bg-neutral-800/90 text-white text-center text-2xl font-semibold p-8 min-h-[5rem] flex items-center justify-center">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6" id="answer-container">
                {% for key in ['a', 'b', 'c', 'd'] %}
                    <span
                        data-key="{{ key }}"
                        id="answer-{{ key }}"
                        class="answer-button flex items-center gap-3 rounded-xl border-2 border-blue-600 bg-neutral-800/80 text-left text-white px-6 py-4 transition-all duration-150 ease-out hover:bg-blue-600/80 hover:border-yellow-400 focus:outline-none"
                    >
          <span class="font-bold">{{ key|upper }}.</span>
          <span class="answer-text"></span>
        </span>
                {% endfor %}
            </div>

        </div>
    </div>

    <script>

        if (typeof window.eventSource !== 'undefined') {
            window.eventSource.close();
        }

        const answers = {
            a: document.getElementById('answer-a'),
            b: document.getElementById('answer-b'),
            c: document.getElementById('answer-c'),
            d: document.getElementById('answer-d'),
        };
        let currentQuestionIndex = 0;

        function highlightStep(index) {
            for (let i = 1; i <= 15; i++) {
                const step = document.getElementById(`step-${i}`);
                if (!step) continue;

                if (i < index) {
                    step.classList.add('bg-blue-600', 'text-white');
                    step.classList.remove('bg-neutral-800');
                } else if (i === index) {
                    step.classList.add('bg-yellow-400', 'text-black');
                    step.classList.remove('bg-neutral-800', 'text-white');
                } else {
                    step.classList.remove('bg-blue-600', 'bg-yellow-400', 'text-black');
                    step.classList.add('bg-neutral-800', 'text-white');
                }
            }
        }

        window.eventSource = new EventSource('{{ mercure("/game/" ~ game.id ~ "/" ~ game.presenterToken) }}');

        window.eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'QUESTION_REVEALED') {
                currentQuestionIndex += 1;
                highlightStep(currentQuestionIndex);
                document.getElementById('question-text').textContent = data.payload.question;
                correctAnswer = data.payload.correctAnswer;
            }

            if (data.type === 'ANSWER_REVEALED') {
                const key = data.payload.key;
                const value = data.payload.text;
                const btn = answers[key];
                if (!btn) return;

                btn.querySelector('.answer-text').textContent = value;
            }

            if (data.type === 'ANSWER_SUBMITTED') {
                const option = data.payload.option;
                const correct = data.payload.correct;

                if (!answers[option]) return;

                if (correct) {
                    answers[option].classList.add('!bg-green-700', '!text-white', '!border-green-900');
                } else {
                    answers[option].classList.add('!bg-red-800', '!text-white', '!border-red-900');
                }
            }

            if (data.type === 'ANSWER_SELECTED') {
                document.querySelectorAll('.answer-button').forEach(btn => {
                    btn.classList.remove('ring-4', 'ring-yellow-400', 'scale-105');
                });
                answers[data.payload.key].classList.add('ring-4', 'ring-yellow-400', 'scale-105');
            }


            console.log(data);
            if (data.type === 'NEXT_ROUND') {
                revealed = {};
                correctAnswer = null;
                selectedBtn = null;

                Object.entries(answers).forEach(([key, el]) => {
                    const answerPrefix = el.querySelector('span.font-bold');
                    const answerText = el.querySelector('span.answer-text');

                    if (answerPrefix) {
                        answerPrefix.textContent = `${key.toUpperCase()}.`;
                    }

                    if (answerText) {
                        answerText.textContent = '';
                    }

                    el.className = 'answer-button flex items-center gap-3 rounded-xl border-2 border-blue-600 bg-neutral-800 text-left text-white px-6 py-4 transition-all duration-150 ease-out hover:bg-blue-600 focus:outline-none';
                });

                document.getElementById('question-text').textContent = '';
                document.getElementById('next-question-container').classList.add('hidden');

                if (data.type === 'END_OF_GAME') {
                    document.getElementById('question-text').textContent = '';
                    document.getElementById('answer-container').innerHTML = '';
                    document.getElementById('next-question-container')?.classList.add('hidden');

                    const congrats = document.createElement('h1');
                    congrats.className = 'text-4xl font-bold text-green-500 text-center mt-10';
                    congrats.textContent = 'ðŸŽ‰ Congratulations! You completed the contest!';
                    document.querySelector('main')?.appendChild(congrats);
                }
            }

            if (data.type === 'END_OF_GAME') {
                window.location.href = '/game/contestant/end';
            }
        };

    </script>
{% endblock %}
